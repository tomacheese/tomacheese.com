name: Auto Copilot Review Response

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to process'
        required: true
        type: number
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write

jobs:
  check-copilot-reviews:
    name: Check and Respond to Copilot Reviews
    runs-on: ubuntu-latest
    
    # æ‰‹å‹•å®Ÿè¡Œã€Copilotãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ã€ã¾ãŸã¯ç‰¹å®šã‚³ãƒ¡ãƒ³ãƒˆæ™‚ã«å®Ÿè¡Œ
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request_review' && github.event.review.user.login == 'copilot-pull-request-reviewer[bot]') ||
      (github.event_name == 'issue_comment' && github.event.issue.pull_request && 
       contains(github.event.comment.body, '/copilot-review'))
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine PR Number
        id: get-pr-number
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã¯å…¥åŠ›å€¤ã‚’ä½¿ç”¨
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
          elif [ "${{ github.event_name }}" = "pull_request_review" ]; then
            # PRãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆ
            PR_NUMBER="${{ github.event.pull_request.number }}"
          elif [ "${{ github.event_name }}" = "issue_comment" ]; then
            # ã‚³ãƒ¡ãƒ³ãƒˆã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆï¼ˆPRã‹ã©ã†ã‹ã¯æ—¢ã«ifæ¡ä»¶ã§ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ï¼‰
            PR_NUMBER="${{ github.event.issue.number }}"
          else
            echo "âŒ Unsupported event type: ${{ github.event_name }}"
            exit 1
          fi
          
          echo "ðŸŽ¯ Processing PR #${PR_NUMBER}"
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT

      - name: Check Rate Limiting
        id: rate-limit
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          PR_NUMBER: ${{ steps.get-pr-number.outputs.pr_number }}
          REPO_NAME: ${{ github.repository }}
        run: |
          # éŽåŽ»1æ™‚é–“ä»¥å†…ã«åŒã˜PRã«å¯¾ã—ã¦è‡ªå‹•ã‚³ãƒ¡ãƒ³ãƒˆãŒæŠ•ç¨¿ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          ONE_HOUR_AGO=$(date -u -d '1 hour ago' '+%Y-%m-%dT%H:%M:%SZ')
          
          RECENT_COMMENTS=$(gh api \
            "/repos/${REPO_NAME}/issues/${PR_NUMBER}/comments" \
            --jq "
            [.[] | 
             select(.user.login == \"github-actions[bot]\" and 
                    .created_at > \"$ONE_HOUR_AGO\" and
                    (.body | contains(\"@Copilot ä»¥ä¸‹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¿®æ­£ã—ã¦ãã ã•ã„\")))] | 
            length")
          
          echo "ðŸ“Š Found ${RECENT_COMMENTS} recent auto-comments in the last hour"
          
          if [ "$RECENT_COMMENTS" -gt 0 ] && [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "â³ Rate limit hit: Recent auto-comment found. Skipping automatic execution."
            echo "skip_execution=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… No rate limiting issues detected"
            echo "skip_execution=false" >> $GITHUB_OUTPUT
          fi

      - name: Collect Copilot Review Comments
        id: collect-reviews
        if: steps.rate-limit.outputs.skip_execution != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          PR_NUMBER: ${{ steps.get-pr-number.outputs.pr_number }}
          REPO_NAME: ${{ github.repository }}
        run: |
          echo "ðŸ” Collecting Copilot review comments for PR #${PR_NUMBER}..."
          
          # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›
          echo "DEBUG: Repository: ${REPO_NAME}"
          echo "DEBUG: PR Number: ${PR_NUMBER}"
          
          # PRã®ä¸€èˆ¬çš„ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
          REVIEW_COMMENTS=$(gh api \
            "/repos/${REPO_NAME}/pulls/${PR_NUMBER}/reviews" \
            --jq '
            [
              .[] | 
              select(.user.login == "copilot-pull-request-reviewer[bot]") |
              select(.state == "COMMENTED" or .state == "commented" or 
                     .state == "CHANGES_REQUESTED" or .state == "changes_requested") |
              {
                id: .id,
                body: .body,
                state: .state,
                submitted_at: .submitted_at
              }
            ]
            ')

          # ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
          INLINE_COMMENTS=$(gh api \
            "/repos/${REPO_NAME}/pulls/${PR_NUMBER}/comments" \
            --jq '
            [
              .[] | 
              select(.user.login == "copilot-pull-request-reviewer[bot]" or 
                     .user.login == "Copilot") |
              {
                id: .id,
                body: .body,
                path: .path,
                line: .line,
                diff_hunk: .diff_hunk
              }
            ]
            ')

          # ã‚³ãƒ¡ãƒ³ãƒˆæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          REVIEW_COUNT=$(echo "$REVIEW_COMMENTS" | jq 'length')
          INLINE_COUNT=$(echo "$INLINE_COMMENTS" | jq 'length')
          
          echo "ðŸ“ Found ${REVIEW_COUNT} review comments and ${INLINE_COUNT} inline comments"
          
          # ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å‡ºåŠ›
          echo "DEBUG: Review comments data:"
          echo "$REVIEW_COMMENTS" | jq '.' || echo "Failed to parse review comments JSON"
          echo "DEBUG: Inline comments data:"
          echo "$INLINE_COMMENTS" | jq '.' || echo "Failed to parse inline comments JSON"
          
          # çµæžœã‚’ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
          echo "review_count=${REVIEW_COUNT}" >> $GITHUB_OUTPUT
          echo "inline_count=${INLINE_COUNT}" >> $GITHUB_OUTPUT
          
          # ã‚³ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆè¤‡æ•°è¡Œãƒ‡ãƒ¼ã‚¿ã®ãŸã‚ï¼‰
          echo "$REVIEW_COMMENTS" > review_comments.json
          echo "$INLINE_COMMENTS" > inline_comments.json

      - name: Generate Copilot Response Comment
        id: generate-comment
        if: >-
          steps.rate-limit.outputs.skip_execution != 'true' &&
          (steps.collect-reviews.outputs.review_count > 0 || 
           steps.collect-reviews.outputs.inline_count > 0)
        env:
          PR_NUMBER: ${{ steps.get-pr-number.outputs.pr_number }}
          REVIEW_COUNT: ${{ steps.collect-reviews.outputs.review_count }}
          INLINE_COUNT: ${{ steps.collect-reviews.outputs.inline_count }}
          TRIGGER_TYPE: ${{ github.event_name }}
        run: |
          # æ—¢å­˜ã®Copilotå†ä¾é ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
          EXISTING_COMMENT=$(gh pr view ${PR_NUMBER} --json comments --jq '
            .comments[] | 
            select(.author.login == "github-actions[bot]" and 
                   (.body | contains("@Copilot ä»¥ä¸‹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¿®æ­£ã—ã¦ãã ã•ã„"))) |
            .id
          ' | head -1)
          
          if [ -n "$EXISTING_COMMENT" ]; then
            echo "âš ï¸ æ—¢ã«è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸCopilotå†ä¾é ¼ã‚³ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã™ (ID: $EXISTING_COMMENT)"
            echo "skip_comment=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã‚’ç”Ÿæˆ
          cat > comment_body.md << 'EOF'
          @Copilot ä»¥ä¸‹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ï¼š

          ## ðŸ¤– Review Comments Summary

          EOF

          # ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã®å‡¦ç†
          if [ "$REVIEW_COUNT" -gt 0 ]; then
            echo "### ðŸ“‹ General Review Comments" >> comment_body.md
            echo "" >> comment_body.md
            
            jq -r '
            .[] | 
            "**Review ID: \(.id)** (submitted: \(.submitted_at))\n\(.body | gsub("\n"; "\n> "))\n\n---\n"
            ' review_comments.json >> comment_body.md
          fi

          # ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã®å‡¦ç†
          if [ "$INLINE_COUNT" -gt 0 ]; then
            echo "### ðŸ“ File-specific Comments" >> comment_body.md
            echo "" >> comment_body.md
            
            jq -r '
            .[] | 
            "**File: `\(.path)` (Line \(.line))**\n> \(.body | gsub("\n"; "\n> "))\n\n---\n"
            ' inline_comments.json >> comment_body.md
          fi

          cat >> comment_body.md << 'EOF'

          ## âœ… Action Required

          ä¸Šè¨˜ã®ã™ã¹ã¦ã®æŒ‡æ‘˜äº‹é …ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

          ---
          EOF
          
          # ãƒˆãƒªã‚¬ãƒ¼æƒ…å ±ã‚’è¿½åŠ 
          if [ "$TRIGGER_TYPE" = "workflow_dispatch" ]; then
            echo "*This comment was automatically generated by GitHub Actions (Manual execution)*" >> comment_body.md
          elif [ "$TRIGGER_TYPE" = "pull_request_review" ]; then
            echo "*This comment was automatically generated by GitHub Actions (Auto-triggered by Copilot review)*" >> comment_body.md
          elif [ "$TRIGGER_TYPE" = "issue_comment" ]; then
            echo "*This comment was automatically generated by GitHub Actions (Triggered by comment command)*" >> comment_body.md
          fi
          
          cat >> comment_body.md << 'EOF'

          ### ðŸš€ How to trigger this workflow:
          - **Auto**: Automatically triggered when Copilot reviews are submitted
          - **Manual (PR)**: Comment `/copilot-review` on this PR
          - **Manual (Actions)**: Actions tab â†’ "Auto Copilot Review Response" â†’ Run workflow
          EOF

          echo "âœ… Generated comment body"
          echo "skip_comment=false" >> $GITHUB_OUTPUT

      - name: Post Comment to PR
        if: >-
          steps.rate-limit.outputs.skip_execution != 'true' &&
          steps.generate-comment.outputs.skip_comment != 'true' && 
          (steps.collect-reviews.outputs.review_count > 0 || 
           steps.collect-reviews.outputs.inline_count > 0)
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          PR_NUMBER: ${{ steps.get-pr-number.outputs.pr_number }}
        run: |
          echo "ðŸ“¤ Posting comment to PR #${PR_NUMBER}..."
          
          # PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
          gh pr comment ${PR_NUMBER} --body-file comment_body.md
          
          echo "âœ… Successfully posted Copilot review response comment"

      - name: Rate Limit Notification
        if: >-
          steps.rate-limit.outputs.skip_execution == 'true' &&
          github.event_name == 'issue_comment' &&
          contains(github.event.comment.body, '/copilot-review')
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          PR_NUMBER: ${{ steps.get-pr-number.outputs.pr_number }}
        run: |
          echo "â³ Posting rate limit notification..."
          
          cat > rate_limit_comment.md << 'EOF'
          ðŸš« **Rate Limit Reached**
          
          Auto Copilot Review Response was recently executed for this PR. Please wait at least 1 hour before triggering it again automatically.
          
          If you need immediate execution, use: Actions tab â†’ "Auto Copilot Review Response" â†’ Run workflow
          EOF
          
          gh pr comment ${PR_NUMBER} --body-file rate_limit_comment.md
          rm -f rate_limit_comment.md

      - name: Clean up temporary files
        if: always()
        run: |
          rm -f review_comments.json inline_comments.json comment_body.md