name: Auto Copilot Review Response

on:
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to process'
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write

jobs:
  check-copilot-reviews:
    name: Check and Respond to Copilot Reviews
    runs-on: ubuntu-latest

    # copilot-swe-agent[bot]ãŒä½œæˆã—ãŸPRã§ã€Copilot reviewã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿å‡¦ç†
    # ã¾ãŸã¯æ‰‹å‹•å®Ÿè¡Œã®å ´åˆ
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event.pull_request.user.login == 'copilot-swe-agent[bot]' &&
       ((github.event.review.user.login == 'copilot-pull-request-reviewer[bot]' && 
         (github.event.review.state == 'commented' || github.event.review.state == 'changes_requested')) ||
        (github.event.comment.user.login == 'copilot-pull-request-reviewer[bot]')))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Collect Copilot Review Comments
        id: collect-reviews
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.inputs.pr_number || github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
        run: |
          echo "ğŸ” Collecting Copilot review comments for PR #${PR_NUMBER}..."

          # PRã®ä¸€èˆ¬çš„ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
          REVIEW_COMMENTS=$(gh api \
            "/repos/${REPO_NAME}/pulls/${PR_NUMBER}/reviews" \
            --jq '
            [
              .[] | 
              select(.user.login == "copilot-pull-request-reviewer[bot]") |
              select(.state == "commented" or .state == "changes_requested") |
              {
                id: .id,
                body: .body,
                state: .state,
                submitted_at: .submitted_at
              }
            ]
            ')

          # ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
          INLINE_COMMENTS=$(gh api \
            "/repos/${REPO_NAME}/pulls/${PR_NUMBER}/comments" \
            --jq '
            [
              .[] | 
              select(.user.login == "copilot-pull-request-reviewer[bot]") |
              {
                id: .id,
                body: .body,
                path: .path,
                line: .line,
                diff_hunk: .diff_hunk
              }
            ]
            ')

          # ã‚³ãƒ¡ãƒ³ãƒˆæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          REVIEW_COUNT=$(echo "$REVIEW_COMMENTS" | jq 'length')
          INLINE_COUNT=$(echo "$INLINE_COMMENTS" | jq 'length')

          echo "ğŸ“ Found ${REVIEW_COUNT} review comments and ${INLINE_COUNT} inline comments"

          # çµæœã‚’ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
          echo "review_count=${REVIEW_COUNT}" >> $GITHUB_OUTPUT
          echo "inline_count=${INLINE_COUNT}" >> $GITHUB_OUTPUT

          # ã‚³ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆè¤‡æ•°è¡Œãƒ‡ãƒ¼ã‚¿ã®ãŸã‚ï¼‰
          echo "$REVIEW_COMMENTS" > review_comments.json
          echo "$INLINE_COMMENTS" > inline_comments.json

      - name: Generate Copilot Response Comment
        id: generate-comment
        if: steps.collect-reviews.outputs.review_count > 0 || steps.collect-reviews.outputs.inline_count > 0
        env:
          PR_NUMBER: ${{ github.event.inputs.pr_number || github.event.pull_request.number }}
          REVIEW_COUNT: ${{ steps.collect-reviews.outputs.review_count }}
          INLINE_COUNT: ${{ steps.collect-reviews.outputs.inline_count }}
        run: |
          # æ—¢å­˜ã®Copilotå†ä¾é ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
          EXISTING_COMMENT=$(gh pr view ${PR_NUMBER} --json comments --jq '
            .comments[] | 
            select(.author.login == "github-actions[bot]" and (.body | contains("@Copilot ä»¥ä¸‹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¿®æ­£ã—ã¦ãã ã•ã„"))) |
            .id
          ' | head -1)

          if [ -n "$EXISTING_COMMENT" ]; then
            echo "âš ï¸ æ—¢ã«è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸCopilotå†ä¾é ¼ã‚³ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã™ (ID: $EXISTING_COMMENT)"
            echo "skip_comment=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # ã‚³ãƒ¡ãƒ³ãƒˆæœ¬æ–‡ã‚’ç”Ÿæˆ
          cat > comment_body.md << 'EOF'
          @Copilot ä»¥ä¸‹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ï¼š

          ## ğŸ¤– Review Comments Summary

          EOF

          # ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã®å‡¦ç†
          if [ "$REVIEW_COUNT" -gt 0 ]; then
            echo "### ğŸ“‹ General Review Comments" >> comment_body.md
            echo "" >> comment_body.md
            
            jq -r '
            .[] | 
            "**Review ID: \(.id)** (submitted: \(.submitted_at))\n\(.body | gsub("\n"; "\n> "))\n\n---\n"
            ' review_comments.json >> comment_body.md
          fi

          # ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã®å‡¦ç†
          if [ "$INLINE_COUNT" -gt 0 ]; then
            echo "### ğŸ“ File-specific Comments" >> comment_body.md
            echo "" >> comment_body.md
            
            jq -r '
            .[] | 
            "**File: `\(.path)` (Line \(.line))**\n> \(.body | gsub("\n"; "\n> "))\n\n---\n"
            ' inline_comments.json >> comment_body.md
          fi

          cat >> comment_body.md << 'EOF'

          ## âœ… Action Required

          ä¸Šè¨˜ã®ã™ã¹ã¦ã®æŒ‡æ‘˜äº‹é …ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚

          ---
          *This comment was automatically generated by GitHub Actions (Copilot Coding Agent PR only)*
          *Manual execution: Actions tab â†’ "Auto Copilot Review Response" â†’ Run workflow*
          EOF

          echo "âœ… Generated comment body"
          echo "skip_comment=false" >> $GITHUB_OUTPUT

      - name: Post Comment to PR
        if: steps.generate-comment.outputs.skip_comment != 'true' && (steps.collect-reviews.outputs.review_count > 0 || steps.collect-reviews.outputs.inline_count > 0)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.inputs.pr_number || github.event.pull_request.number }}
        run: |
          echo "ğŸ“¤ Posting comment to PR #${PR_NUMBER}..."

          # PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
          gh pr comment ${PR_NUMBER} --body-file comment_body.md

          echo "âœ… Successfully posted Copilot review response comment"

      - name: Clean up temporary files
        if: always()
        run: |
          rm -f review_comments.json inline_comments.json comment_body.md
